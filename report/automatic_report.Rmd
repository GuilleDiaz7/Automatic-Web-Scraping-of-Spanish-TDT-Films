---
title: "Spanish TDT movies report"
author: "Guillermo Diaz"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_align: "left"
    toc_depth: 2
    theme: "yeti"
  pdf_document:
    toc: yes
    toc_depth: '2'
lang: "es-ES"
---


```{r}
#| echo = FALSE
options(knitr.table.format = "html") 
```

# Introduction

[GitHub](https://github.com/GuilleDiaz7)

This line of code is quite magical. Change any `opts_chunk` here and it will change setting for the entire document. You can set any option you want: `echo`, `include`, `warning` or `messages`.

```{r setup}
#| include = TRUE
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

\newpage
# Load and clean data

```{r Load and prepare data}
#| warning = FALSE,
#| include = FALSE,
#| messages = FALSE
library(dplyr)
library(tidyr)


data <- read.csv("https://raw.githubusercontent.com/GuilleDiaz7/Automatic-Web-Scraping-of-Spanish-TDT-Films/main/data/pelis_tv_hoy.csv", fileEncoding = 'UTF-8')

df <- data %>% mutate(
  genre = replace(genre, genre == "Suspense / Thriller", "Suspense"),
  genre = replace(genre, genre == "Documentales", "Documental"),
  genre = replace(genre, genre == "Ciencia ficci?n", "SyFy"),
  genre = replace(genre, genre == "Infantil/Familiar", "Infantil")
)
```

The data set contains `r nrow(df)` instances and `r ncol(df)` variables. From now on, we won't be using the variable `Description`, which included a brief synopsis of each film. Let's see a few examples of the data.

```{r}
#| warning = FALSE
library(knitr)
library(kableExtra)
df_no_desc <- df %>% 
  select(1:8)

df_no_desc %>% 
  head(3) %>% 
  knitr::kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = T)
```

The variables names are formatted to work with them in R, not to be shown in a document. We can clean them.


```{r}
df_clean <- df_no_desc %>% 
  dplyr::rename(
    Date = date_time,
    Channel = channel,
    "Spanish title" = sp_title,
    "Original title" = original_title,
    Year = year,
    Genre = genre,
    Country = country,
    Length = length
  )

# Hay varios temas predeterminados en kableExtra, como kable_paper()
df_clean %>% 
  head(3) %>% 
  knitr::kable() %>%
  kable_paper()
```


This is so much better. I want to see some examples with `Country` and `Length` data.

```{r}
df_clean %>% 
  drop_na() %>%
  head() %>% 
  knitr::kable()
```


I don't like to see the unit in the `Length` column. I also noticed to that film genres are in Spanish. Let's clean the length.

```{r}
#| error = FALSE
library(readr)
df_clean$Length <- as.integer(parse_number(df_clean$Length))

```


```{r}

df_clean %>% 
  drop_na() %>% 
  head(4) %>%
  knitr::kable()

  
```
How long are the films show in TV?

```{r}
library(ggplot2)
df_clean %>% 
  drop_na() %>% 
  ggplot(aes(x = Length)) +
    geom_histogram(aes(y=..density..), binwidth = 1) +
    geom_density(alpha = 0.2, fill = "#FF6666") +
    theme_classic()
  
```


¿How many unique values there are in each variable?

```{r distinct values}
library(purrr)
df %>% map_dbl(
  n_distinct
)
```

So, if there are `r nrow(df)` instances, why do we only have `r n_distinct(df$sp_title)` movies? I guess some of them were broadcasted more than once. These are the ones:

```{r}
df_clean %>% 
  group_by(`Spanish title`) %>% 
  summarise(Emisiones = n()) %>% 
  filter(Emisiones > 1) %>% 
  arrange(desc(Emisiones)) %>% 
  knitr::kable(full_width = TRUE)

```
\newpage
# Mapping the data

First, we have to prepare the data. Country names are in Spanish, let's translate them.

```{r}
unique(df_clean$Country)
```


```{r}
df_map <- df_clean %>% 
  group_by(`Country`) %>% 
  summarise(Movies = n())

df_map <- df_map %>% 
  mutate(
    Country = case_when(
      Country == "Alemania" ~ "Germany",
      Country == "Canadá" ~ "Canada",
      Country == "Dinamarca" ~ "Denmark",
      Country == "España" ~ "Spain",
      Country == "Estados Unidos" ~ "United States of America",
      Country == "Italia" ~ "Italy",
      Country == "Reino Unido" ~ "United Kingdom",
      Country == "Corea del Sur" ~ "South Korea",
      Country == "Francia" ~ "France",
      Country == "Sudáfrica" ~ "South Africa",
      is.na(Country) == TRUE ~ "Sin datos"
    )
  )

df_map
```
Then, we plot a map

```{r}
library(sf)
library(rnaturalearth)

world <- ne_countries(scale = "small", returnclass = "sf")
world
world %>% 
  ggplot() + 
  geom_sf() +
  geom_hline(yintercept = 0, linetype = "dashed") 

```
The latter was an empty world map. We are goint to fill it with our data. We create a suitable data frame.

```{r}
world <- world %>% 
  dplyr::rename("Country" = "sovereignt")

df_world <- left_join(world, df_map)

```

Let's see how it looks filled.

```{r}
library(ggplot2)
library(sf)
df_world %>% 
  ggplot() +
  geom_sf(aes(fill = Movies)) +
  theme_void() +
  theme(legend.position = "top") +
  labs(fill = "Number of movies:") +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE))
```

